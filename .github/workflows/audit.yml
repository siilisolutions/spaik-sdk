name: Security Audit

on:
  workflow_dispatch:
    inputs:
      fail_on_severity:
        description: 'Minimum severity to fail on (JS only, Python always fails on any vuln)'
        required: false
        default: 'high'
        type: choice
        options:
          - low
          - moderate
          - high
          - critical

jobs:
  # Python packages - run in parallel
  audit-agent-sdk:
    name: Audit agent-sdk (Python)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/agent-sdk
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      - name: Set up Python
        run: uv python install 3.10
      - name: Install dependencies
        run: uv sync
      - name: Install pip-audit
        run: uv pip install pip-audit
      - name: Export requirements and audit
        run: |
          # Export and filter out local/editable packages (lines starting with . or #)
          uv export --no-dev --no-editable --no-hashes --format requirements-txt 2>/dev/null | grep -E "^[a-zA-Z]" > requirements-audit.txt
          # --disable-pip and --no-deps avoid venv creation issues with uv-installed Python
          uv run python -m pip_audit -r requirements-audit.txt --strict --desc on --progress-spinner off --disable-pip --no-deps

  audit-coding-agents:
    name: Audit coding-agents (Python)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/coding-agents
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      - name: Set up Python
        run: uv python install 3.10
      - name: Install dependencies
        run: uv sync --all-extras
      - name: Install pip-audit
        run: uv pip install pip-audit
      - name: Export requirements and audit
        run: |
          # Export and filter out local/editable packages (lines starting with . or #)
          uv export --no-dev --no-editable --no-hashes --format requirements-txt 2>/dev/null | grep -E "^[a-zA-Z]" > requirements-audit.txt
          # --disable-pip and --no-deps avoid venv creation issues with uv-installed Python
          uv run python -m pip_audit -r requirements-audit.txt --strict --desc on --progress-spinner off --disable-pip --no-deps

  audit-agent-workflows:
    name: Audit agent-workflows (Python)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/agent-workflows
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      - name: Set up Python
        run: uv python install 3.10
      - name: Install dependencies
        run: uv sync --all-extras
      - name: Install pip-audit
        run: uv pip install pip-audit
      - name: Export requirements and audit
        run: |
          # Export and filter out local/editable packages (lines starting with . or #)
          uv export --no-dev --no-editable --no-hashes --format requirements-txt 2>/dev/null | grep -E "^[a-zA-Z]" > requirements-audit.txt
          # --disable-pip and --no-deps avoid venv creation issues with uv-installed Python
          uv run python -m pip_audit -r requirements-audit.txt --strict --desc on --progress-spinner off --disable-pip --no-deps

  # JavaScript/TypeScript packages - bun audit on entire monorepo lockfile
  audit-js-packages:
    name: Audit JS packages (bun)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install dependencies
        run: bun install --frozen-lockfile
      - name: Run security audit
        run: |
          # bun audit checks the entire lockfile
          # Map severity input to bun audit exit behavior
          SEVERITY="${{ inputs.fail_on_severity || 'high' }}"
          
          # Run audit and capture output
          set +e
          OUTPUT=$(bun audit 2>&1)
          EXIT_CODE=$?
          set -e
          
          echo "$OUTPUT"
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "✅ No vulnerabilities found"
            exit 0
          fi
          
          # Check if we should fail based on severity
          case "$SEVERITY" in
            "critical")
              if echo "$OUTPUT" | grep -q "critical"; then
                echo "::error::Critical vulnerabilities found"
                exit 1
              fi
              ;;
            "high")
              if echo "$OUTPUT" | grep -qE "(critical|high)"; then
                echo "::error::High or critical vulnerabilities found"
                exit 1
              fi
              ;;
            "moderate")
              if echo "$OUTPUT" | grep -qE "(critical|high|moderate)"; then
                echo "::error::Moderate or higher vulnerabilities found"
                exit 1
              fi
              ;;
            "low")
              # Any vulnerability fails
              echo "::error::Vulnerabilities found"
              exit 1
              ;;
          esac
          
          echo "⚠️ Vulnerabilities found but below threshold ($SEVERITY)"
          exit 0

  # Summary job that depends on all audit jobs
  audit-summary:
    name: Audit Summary
    runs-on: ubuntu-latest
    needs:
      - audit-agent-sdk
      - audit-coding-agents
      - audit-agent-workflows
      - audit-js-packages
    if: always()
    steps:
      - name: Check audit results
        run: |
          echo "## Security Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check each job result
          declare -A results
          results["agent-sdk (Python)"]="${{ needs.audit-agent-sdk.result }}"
          results["coding-agents (Python)"]="${{ needs.audit-coding-agents.result }}"
          results["agent-workflows (Python)"]="${{ needs.audit-agent-workflows.result }}"
          results["JS packages (bun)"]="${{ needs.audit-js-packages.result }}"
          
          failed=0
          for pkg in "${!results[@]}"; do
            status="${results[$pkg]}"
            if [ "$status" = "success" ]; then
              echo "✅ **$pkg**: Passed" >> $GITHUB_STEP_SUMMARY
            elif [ "$status" = "failure" ]; then
              echo "❌ **$pkg**: Failed - vulnerabilities found" >> $GITHUB_STEP_SUMMARY
              failed=1
            else
              echo "⚠️ **$pkg**: $status" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ $failed -eq 1 ]; then
            echo "### ⚠️ Action Required" >> $GITHUB_STEP_SUMMARY
            echo "One or more packages have security vulnerabilities that need to be addressed." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "### ✅ All Clear" >> $GITHUB_STEP_SUMMARY
            echo "No security vulnerabilities found above the configured threshold." >> $GITHUB_STEP_SUMMARY
          fi
